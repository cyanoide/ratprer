<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Écran RATP - Temps Réel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --header-bg: #2b2b2b;
            --row-bg-1: #003366;
            /* Dark Blue for rows */
            --row-bg-2: #004080;
            /* Slightly lighter for alternating? Or just same */
            --text-white: #ffffff;
            --text-yellow: #ffcc00;
            /* RATP Yellow for time */
            --rer-b-color: #5291ce;
            --t10-olive: #6E6E00;
            /* Olive green for T10 bars */
            --delay-color: #ff9999;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-white);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background-color: var(--header-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #444;
        }

        .station-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 1.1em;
            color: #ccc;
        }

        select {
            background-color: #444;
            color: white;
            border: 1px solid #666;
            padding: 5px 10px;
            font-size: 1em;
            border-radius: 4px;
        }

        .clock {
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            background-color: #000080;
            /* Dark blue box for clock */
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid white;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .seconds {
            font-size: 0.5em;
            color: var(--text-yellow);
        }

        /* Schedule List */
        .schedule-container {
            width: 100%;
        }

        .schedule-row {
            display: flex;
            align-items: center;
            background-color: var(--row-bg-1);
            border-bottom: 1px solid #0055a4;
            padding: 5px 10px;
            height: 80px;
        }

        .schedule-row:nth-child(even) {
            background-color: var(--row-bg-2);
        }

        /* Columns */
        .col-mission {
            width: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-right: 1px solid #0055a4;
            padding-right: 10px;
        }

        .mission-code {
            font-size: 1.4em;
            font-weight: 800;
            /* Extra Bold */
            text-transform: uppercase;
        }

        .mission-status {
            font-size: 0.9em;
            margin-top: 2px;
        }

        .col-time {
            width: 130px;
            /* Widened for "A l'approche" */
            font-size: 2.2em;
            font-weight: 800;
            /* Extra Bold */
            color: var(--text-yellow);
            text-align: center;
            padding: 0 15px;
            white-space: nowrap;
        }

        .col-time.text-small {
            font-size: 1.2em;
            /* Smaller font for "A l'approche" */
        }

        .col-line {
            width: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .line-icon {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 8px;
            /* RER style square-ish */
        }

        .line-b {
            background-color: var(--rer-b-color);
            color: white;
        }

        /* T10 Logo Style matching the image */
        .line-t10-container {
            width: 50px;
            height: 50px;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            /* Slight rounding */
            overflow: hidden;
        }

        .t10-bar {
            width: 100%;
            height: 10px;
            background-color: var(--t10-olive);
        }

        .t10-text {
            color: black;
            font-weight: 900;
            font-size: 1.4em;
            line-height: 1;
        }

        .col-dest {
            flex: 1;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
            /* Important for ellipsis to work in flex child */
        }

        .destination-name {
            font-size: 2em;
            font-weight: 700;
            /* Bold */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .destination-sub {
            font-size: 1em;
            color: #aaccff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading,
        .error {
            padding: 40px;
            text-align: center;
            font-size: 1.5em;
            color: #aaa;
        }

        .error {
            color: #ff6666;
        }
    </style>
</head>

<body>

    <header>
        <div class="station-selector">
            <label for="station-select">Départ :</label>
            <select id="station-select" onchange="updateStation()">
                <option value="massy_b">Massy - Palaiseau (RER B)</option>
                <option value="croix_b">La Croix de Berny (RER B)</option>
                <option value="croix_t10">La Croix de Berny (T10)</option>
                <option value="parc_t10">Parc des Sports (T10)</option>
            </select>
        </div>
        <div class="clock" id="clock">
            <span id="clock-time">--:--</span><span class="seconds" id="clock-seconds">00</span>
        </div>
    </header>

    <div class="schedule-container" id="schedule-container">
        <div class="loading">Chargement des horaires...</div>
    </div>

    <script>
        const API_KEY = 'bV9X6QEkuJZZ1BFAL2maQfueIqGtRi6J';

        const STATIONS = {
            'massy_b': { id: 'stop_area:IDFM:63244', mode: 'RER', line: 'B' },
            'croix_b': { id: 'stop_area:IDFM:69813', mode: 'RER', line: 'B' },
            'croix_t10': { id: 'stop_area:IDFM:69813', mode: 'Tramway', line: 'T10' },
            'parc_t10': { id: 'stop_area:IDFM:70009', mode: 'Tramway', line: 'T10' }
        };

        let currentStationKey = 'massy_b';
        let refreshInterval;

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('clock-time').textContent = `${hours}:${minutes}`;
            document.getElementById('clock-seconds').textContent = seconds;
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateStation() {
            const select = document.getElementById('station-select');
            currentStationKey = select.value;
            fetchSchedules();
        }

        async function fetchSchedules() {
            const container = document.getElementById('schedule-container');
            // Don't clear immediately to avoid flicker on refresh, only on station change
            // But here we just call it 'loading' if it's a manual change? 
            // Let's just keep the old data until new data arrives if possible, or show loading if empty.
            if (!container.hasChildNodes() || container.querySelector('.loading')) {
                container.innerHTML = '<div class="loading">Chargement...</div>';
            }

            const station = STATIONS[currentStationKey];

            try {
                const response = await fetch(`https://prim.iledefrance-mobilites.fr/marketplace/v2/navitia/stop_areas/${station.id}/departures?count=20`, {
                    headers: { 'apiKey': API_KEY }
                });

                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

                const data = await response.json();

                // Filter
                const departures = data.departures.filter(d =>
                    d.display_informations.commercial_mode === station.mode &&
                    d.display_informations.label === station.line
                );

                renderSchedules(departures, station);

            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = `<div class="error">Erreur de connexion: ${error.message}</div>`;
            }
        }

        function renderSchedules(departures, stationConfig) {
            const container = document.getElementById('schedule-container');

            if (departures.length === 0) {
                container.innerHTML = '<div class="error">Aucun train à l\'affichage.</div>';
                return;
            }

            let html = '';

            departures.forEach(dep => {
                const info = dep.display_informations;
                const timeInfo = dep.stop_date_time;

                // 1. Mission Code
                let mission = info.headsign || info.trip_short_name || '';
                if (stationConfig.line === 'T10') {
                    mission = ''; // T10 usually doesn't show mission codes on screens, just destination
                }

                // 2. Time & Status (Delay)
                const baseTime = parseNavitiaDate(timeInfo.base_departure_date_time);
                const realTime = parseNavitiaDate(timeInfo.departure_date_time);
                const now = new Date();

                // Calculate delay for status text
                const delayMinutes = Math.round((realTime - baseTime) / 60000);
                let statusText = "à l'heure";
                if (delayMinutes > 0) statusText = `+${delayMinutes} min`;

                // Calculate display time logic
                const diffMs = realTime - now;
                const diffMins = Math.floor(diffMs / 60000);

                let displayTime = '';
                let timeClass = 'col-time';

                if (diffMins < 1) {
                    displayTime = "A l'approche";
                    timeClass += ' text-small';
                } else if (diffMins < 10) {
                    displayTime = `${diffMins} min`;
                } else {
                    displayTime = realTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                }

                // 3. Line Icon
                let lineIconHtml = '';
                if (stationConfig.line === 'B') {
                    lineIconHtml = '<div class="line-icon line-b">B</div>';
                } else {
                    // New T10 Logo Style
                    lineIconHtml = `
                        <div class="line-t10-container">
                            <div class="t10-bar"></div>
                            <div class="t10-text">T10</div>
                            <div class="t10-bar"></div>
                        </div>
                    `;
                }

                // 4. Destination & Subtext
                let destination = info.direction;

                // Fix for long T10 destination
                if (destination.includes("La Croix de Berny")) {
                    destination = "La Croix de Berny"; // Shorten it
                }

                let subtext = info.description || "";
                // Clean up subtext if it's just the same as destination or empty
                if (subtext === destination) subtext = "";

                html += `
                    <div class="schedule-row">
                        <div class="col-mission">
                            <div class="mission-code">${mission}</div>
                            <div class="mission-status">${statusText}</div>
                        </div>
                        <div class="${timeClass}">${displayTime}</div>
                        <div class="col-line">${lineIconHtml}</div>
                        <div class="col-dest">
                            <div class="destination-name" title="${destination}">${destination}</div>
                            <div class="destination-sub">${subtext}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function parseNavitiaDate(isoString) {
            // YYYYMMDDTHHMMSS
            if (!isoString) return new Date();
            const year = parseInt(isoString.substring(0, 4));
            const month = parseInt(isoString.substring(4, 6)) - 1;
            const day = parseInt(isoString.substring(6, 8));
            const hour = parseInt(isoString.substring(9, 11));
            const minute = parseInt(isoString.substring(11, 13));
            const second = parseInt(isoString.substring(13, 15));
            return new Date(year, month, day, hour, minute, second);
        }

        // Auto Refresh
        document.addEventListener('DOMContentLoaded', () => {
            fetchSchedules();
            refreshInterval = setInterval(fetchSchedules, 30000); // Refresh every 30s
        });

    </script>
</body>

</html>